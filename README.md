# uma-dv

A CLI for UMA protocol dispute voting. Fetches active votes from the VotingV2 contract, resolves human-readable question text (including cross-chain Polygon disputes), and surfaces Discord community summaries so you can make informed voting decisions.

## Install

```sh
bun install
```

Requires [Bun](https://bun.sh) v1.2+.

## Commands

### `stage`

Show the current voting phase for the active round.

```
$ bun src/index.ts stage
Round 10252: Reveal phase

$ bun src/index.ts stage --json
{"round":10252,"phase":"Reveal"}
```

### `list`

List all active votes for the current round with descriptions, vote options, and Discord community summaries.

```
$ bun src/index.ts list

  UMA Dispute Voter CLI
══════════════════════════════════════════════════════════════════════
  Round:  10252   Phase: Reveal   Ends: Sun, 22 Feb 2026 00:00:00 UTC

  9 active votes in Round #10252:

──────────────────────────────────────────────────────────────────────
  [1] YES_OR_NO_QUERY  Dispute
──────────────────────────────────────────────────────────────────────
  Time:     Wed, 18 Feb 2026 21:16:00 UTC

  Question / Description:
  Will Trump say "Smart" or "High IQ" during the Black History
    Month reception?

  Vote Options:
  ● Yes                            1e18 (1000000000000000000)
  ● No                             0
  ● Ambiguous / Too early to tell  0.5e18 (500000000000000000)

  Discord Summary (Feb 20, 2026 · 5 comments)
  P2: • Supporters contend that the market should resolve to P2 because
      it has been clarified
  Uncategorized: • A contributor provides rule clarifications and
      references official sources
```

Pass `--json` / `-j` for structured output (useful for piping to other tools or LLMs):

```
$ bun src/index.ts list --json | jq '.votes[0] | {description, phase: .options[].label}'
```

### Options

All commands accept:

| Flag | Description | Default |
|------|-------------|---------|
| `-r, --rpc-url <url>` | Ethereum RPC URL | `https://eth.llamarpc.com` |
| `-j, --json` | Machine-readable JSON output | `false` |

## How it works

**Vote resolution:**
Most active UMA votes originate on Polygon via Polymarket's OptimisticOracleV2. The mainnet ancillary data only contains a `keccak256` hash of the original question. The CLI resolves the human-readable question by:

1. Extracting `childOracle`, `childBlockNumber`, and `ancillaryDataHash` from the mainnet ancillary data
2. Scanning logs from the `OracleChildTunnel` contract on Polygon around the originating block
3. Decoding `PriceRequestAdded` events and verifying the `keccak256` hash matches

Multiple ABI decode strategies are tried in order (specific event layouts → brute-force scan), with fallback to multiple public RPC endpoints.

**Discord summaries:**
The CLI fetches LLM-generated summaries of Discord community comments from `vote.uma.xyz/api/fetch-summary`. These are pre-generated by UMA's backend and cached in Redis. Each summary is organized by outcome (P1/P2/P3/P4) showing what arguments the community is making for each resolution.

> **Note:** Discord summaries may not be available for all votes and should be verified independently before voting.

## Development

```sh
# Run unit tests (fast, no network)
bun test tests/list.test.ts

# Run integration tests (live Polygon RPC calls)
bun test tests/crosschain.test.ts

# Run all tests
bun test
```

## Contract addresses

| Contract | Network | Address |
|----------|---------|---------|
| VotingV2 | Ethereum mainnet | `0x004395edb43EFca9885CEdad51EC9fAf93Bd34ac` |
| OracleChildTunnel | Polygon | `0xac60353a54873c446101216829a6A98cDbbC3f3D` |
| OptimisticOracleV2 | Polygon | `0xee3afe347d5c74317041e2618c49534daf887c24` |
